{% extends "base.html" %}

{% block title %}ğŸ“‹ ì—¬í–‰ ì¼ì •{% endblock %}

{% block content %}
<div class="grid-container">

  <!-- âœ… ì™¼ìª½: ì‚¬ìš©ì ì…ë ¥ìš© ì‚¬ì´ë“œë°” -->
  {% include "sidebar.html" %}

  <!-- âœ… ì¤‘ì•™: ì—¬í–‰ ì¼ì • ê²°ê³¼ -->
  <div class="center-panel">
    <div class="header-row">
      <h3>ğŸ“… ì—¬í–‰ ì¼ì •</h3>

      {% if result %}
      <!-- âœ… PDF ì €ì¥: textarea ì‚¬ìš©ìœ¼ë¡œ ê¸¸ì´ ì œí•œ íšŒí”¼ -->
      <form method="POST" action="{{ url_for('download_pdf') }}">
        <textarea name="result_html" style="display: none;">{{ result | safe }}</textarea>
        <button type="submit" class="pdf-btn">ğŸ“„ PDFë¡œ ì €ì¥í•˜ê¸°</button>
      </form>
      {% endif %}
    </div>

    <div class="itinerary-box">
      {% if result %}
        {{ result | safe }}
      {% else %}
        <p style="color: gray;">ì™¼ìª½ì—ì„œ ì¡°ê±´ì„ ì…ë ¥í•˜ê³  ì¼ì •ì„ ìƒì„±í•´ë³´ì„¸ìš”!</p>
      {% endif %}
    </div>
  </div>

  <!-- âœ… ì˜¤ë¥¸ìª½: ì¹´ì¹´ì˜¤ ì§€ë„ -->
  <div class="right-panel">
    <h3>ğŸ—ºï¸ ì§€ë„</h3>
    <div id="map" style="width: 100%; height: 500px;"></div>
  </div>

</div>

<!-- âœ… ìŠ¤íƒ€ì¼ -->
<style>
.place-link {
  color: #007bff;
  cursor: pointer;
  text-decoration: underline;
}
.place-link:hover {
  background-color: #eaf4ff;
}
.itinerary-box {
  white-space: pre-wrap;
  line-height: 1.6;
  font-size: 15px;
}
</style>

<!-- âœ… ì¹´ì¹´ì˜¤ ì§€ë„ -->
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey={{ kakao_key }}&autoload=false"></script>
<script>
kakao.maps.load(function () {
  let currentInfoWindow = null;

  const mapContainer = document.getElementById('map');
  const center = new kakao.maps.LatLng({{ center_lat }}, {{ center_lng }});
  const map = new kakao.maps.Map(mapContainer, { center: center, level: 6 });

  const markerData = {{ markers | tojson | safe }};
  const markerDict = {};

  markerData.forEach(m => {
    const pos = new kakao.maps.LatLng(m.lat, m.lng);
    const marker = new kakao.maps.Marker({ map, position: pos });
    const info = new kakao.maps.InfoWindow({
      content: `
        <div style="padding:6px 10px; font-size:13px;">
          <b>${m.day} ${m.time}</b><br>
          <b>${m.name}</b><br>
          ${m.desc}
        </div>`
    });
    kakao.maps.event.addListener(marker, 'click', () => {
      if (currentInfoWindow) currentInfoWindow.close();
      info.open(map, marker);
      currentInfoWindow = info;
    });
    markerDict[m.name] = { marker, info, pos };
  });

  document.querySelectorAll('.place-link').forEach(el => {
    el.addEventListener('click', () => {
      const name = el.dataset.name;
      const data = markerDict[name];
      if (!data) return;

      if (currentInfoWindow) currentInfoWindow.close();
      map.setCenter(data.pos);
      data.info.open(map, data.marker);
      currentInfoWindow = data.info;
    });
  });
});
</script>
{% endblock %}
